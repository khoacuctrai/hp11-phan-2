{% extends 'shop/base.html' %}
{% load humanize %}
{% block content %}
<div class="container my-5">
  <div class="row justify-content-center align-items-start">
    <!-- QR Code Column -->
    <div class="col-md-5 text-center mb-4">
      <div class="card shadow-sm rounded-4 p-4">
        <h3 class="mb-3 text-success fw-bold">Quét mã QR để thanh toán</h3>
        <div class="qr-container my-3">
          <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code thanh toán"
               class="img-fluid p-3 border rounded-3 shadow qr-glow">
        </div>
        <div class="mt-3">
          <span class="fs-5 text-dark">Số tiền:</span>
          <span class="js-money" data-money="{{ final_total }}">{{ final_total }}</span>
        </div>
        {% if coupon %}
          <div class="mt-2 text-success">Đã áp dụng mã <strong>{{ coupon.code }}</strong> (−{{ coupon.discount }}%)</div>
        {% endif %}
      </div>
    </div>

    <!-- Order Info & Form Column -->
    <div class="col-md-7">
      <div class="card shadow-sm rounded-4 p-4">
        <h4 class="mb-3 text-primary">Thông tin đơn hàng</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle mb-4">
            <thead class="table-light">
              <tr>
                <th>Sản phẩm</th>
                <th>Phiên bản</th>
                <th class="text-center">Số lượng</th>
                <th class="text-end">Thành tiền</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td>{{ it.product }}</td>
                <td>{{ it.variant }}</td>
                <td class="text-center">{{ it.quantity }}</td>
                <td class="text-end">
                  <span class="js-money" data-money="{{ it.subtotal }}">{{ it.subtotal }}</span>
                </td>
              </tr>
              {% endfor %}
              <tr class="table-secondary">
                <td colspan="3" class="text-end fw-bold">Tạm tính</td>
                <td class="text-end"><span class="js-money" data-money="{{ subtotal }}">{{ subtotal }}</span></td>
              </tr>
              <tr class="table-secondary">
                <td colspan="3" class="text-end fw-bold">Giảm giá</td>
                <td class="text-end"><span class="js-money" data-money="{{ discount_amount }}">{{ discount_amount }}</span></td>
              </tr>
              <tr class="table-secondary">
                <td colspan="3" class="text-end fw-bold">Thanh toán</td>
                <td class="text-end"><span class="js-money" data-money="{{ final_total }}">{{ final_total }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <h4 class="mt-4 mb-3 text-primary">Thông tin người mua</h4>
        <form method="post" class="needs-validation" novalidate>
          {% csrf_token %}
          {{ form.as_p }}
          <button type="submit" class="btn btn-success btn-lg px-4 mt-2 rounded-pill shadow">
            <i class="fas fa-check-circle"></i> Xác nhận thanh toán
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
<style>
  .qr-glow { box-shadow: 0 0 24px 6px #40c9ff99, 0 0 2px #fff; }
</style>
<script>
function fmt(n){return Number(n).toLocaleString('vi-VN')+'đ'}
document.querySelectorAll('.js-money').forEach(el=>{
  const v = el.dataset.money || el.textContent.replace(/\D/g,'');
  if(v) el.textContent = fmt(v);
});
</script>
{% endblock %}
